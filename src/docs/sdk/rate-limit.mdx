---
title: Rate Limit
sidebar_order: 8
---

Both [/store](/store) and [/envelope](/envelopes) endpoints return information about rate limit via HTTP responses headers.
The store endpoint only supports HTTP 429, Retry-After header. While the envelope endpoint includes information about categories.
This document describes how it works and how an SDK can handle it.

## HTTP Responses

Rate limits are communicated to downstream clients (both Relay and SDKs) via status codes and a custom response header. 

For regular rate limit responses, the only one the store endpoint supports, emits a `[429](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429)`
 status code and specify a [`Retry-After`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Retry-After) header.

The envelope endpoint on the other hand also includes a special response header containing a list of all rate limits in addition to other information.

To inform downstream clients (both Relay and SDKs) about the rate limits that applied, a custom response header is appended:

```python
X-Sentry-Rate-Limits: *quota_limit*, *quota_limit*, ...
```

Each *quota_limit* has the form `retry_after:categories:scope:...` with the following parameters:

- `retry_after`: Number of seconds until this rate limit expires.
- `categories`: Semicolon separated list of categories. **If empty, this limit applies to all categories**.
- `scope`: The scope that this limit applies to. Can be ignored by SDKs.
- More parameters can be added in the future.

The header may contain spaces which need to be ignored. Relay will only emit spaces after `,` to separate *quota_limits*.

```json
{
  "": 60,
  "event": 10002700,
  "transaction": 10000060,
  "security": 10009000,
}
```

**Example response** (formatted for readability):

```python
HTTP/1.1 429 Too Many Requests
Retry-After: 2700
X-Sentry-Rate-Limits: 
  60:transaction:key, 
  2700:default;error;security:organization
```

**Example response** (with empty categories list):

```python
HTTP/1.1 429 Too Many Requests
Retry-After: 60
X-Sentry-Rate-Limits: 60::organization, 2700::organization
```

- [Accepted] Option 1: Header-based solution
- [Discarded] Option 2: Header-based solution
- [Discarded] Option 3: JSON response body solution

## Client Enforcement

Clients are expected to honor 429 responses and rate limits communicated from Sentry by stopping data transmission until the rate limit has expired. Events, transactions and sessions during this period are to be discarded.

### Stage 1: Parse Response Headers

To detect rate limits in a response from Sentry, apply the following steps:

1. On **every** response, look for `X-Sentry-Rate-Limits`. If present, parse it and immediately go to Stage 2.
2. On `429` responses, look for `Retry-After`. If present, treat it like `scope=key` and `categories=[]` and go to Stage 2. It is allowed but not required to do this on other status codes.
3. Otherwise, there are no rate limits communicated by Sentry.

### Stage 2: Determine Rate Limits

The exact behavior depends on the feature level of the Client:

- Clients are generally allowed to ignore any dimension (such as `category` or `scope`) if they do not support it. However, if they have explicit support, they must obey them. 
For example, an SDK without support for tracing may ignore `transaction`, but SDKs with tracing must also implement and obey the `transaction` category.
- SDKs that only support one event type can ignore `X-Sentry-Rate-Limits` and use the `Retry-After` **header to determine rate limit expiration.
- SDKs that support multiple event types must parse the `categories` dimension. For each category, they should maintain a separate limit, and another separate limit for the implicit "all" category. They can ignore the `scope`, as long as they only support one DSN per instance.
- Proxy clients like Relay should create one limit-bucket per (`category`, `scope`) combination since they both handle multiple categories and scopes.
- Categories and scopes that are unknown to the client should be ignored. The limit still applies to the known categories. Clients should expect that more will be added in the future.
- Limits where **all** categories are unknown must be ignored. Do not apply unknown categories to a default category. Note that this is distinct from limits with no category, which implicitly apply to all categories (think of this as a magic category).
- Always keep the maximum rate limit if multiple rate limits reference the same bucket. If a new rate limit is shorter than an already cached rate limit, then keep the longer one.
- Unknown dimensions must be ignored, i.e., all additional colons and text after the scope.
- `X-Sentry-Rate-Limits` returned in `200 OK` responses should be treated like on 429 responses. Sentry may choose to respond with `200 OK` regardless of a rate limit or may choose to inform a client proactively about a rate limit that is unrelated to the current request. This happens specifically for *reject-all quotas* to prevent clients from sending requests.

## Resources

* [Code in Relay `EnvelopeLimiter`](https://github.com/getsentry/relay/blob/79ebd1e64e72f302b87f28dd6c595a6c167eea44/relay-server/src/utils/rate_limits.rs#L159-L169)
* Unit tests in
  * [Python](https://github.com/getsentry/sentry-python/blob/e873bdb071146b1fd31814ae5f742f6a4f7abe39/tests/test_transport.py#L133-L187)
  * [Java](https://github.com/getsentry/sentry-java/blob/fa78ed4b5ba7cc4af373e0e981b0f9c88e419a72/sentry/src/test/java/io/sentry/transport/HttpTransportTest.kt#L146-L161)
  * [Swift](https://github.com/getsentry/sentry-cocoa/blob/fc02d71795aa047382332dbc198aac40b59852fa/Tests/SentryTests/Networking/RateLimits/SentryDefaultRateLimitsTests.swift)
  * [TypeScript](https://github.com/getsentry/sentry-javascript/blob/8601648ab97ab965f75ae81d51a9ff76066c0a1e/packages/browser/test/unit/transports/fetch.test.ts#L135-L453)

